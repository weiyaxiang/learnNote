# 大纲

## 1、分布式协调服务器

paxos算法

leader选举

## 2、分布式rpc框架Dubbo

Netty
NIO AIO BIO

## 3、反向代理服务器Nginx

1. 静态代理
2. 动静分离
3. 负载均衡
4. 虚拟主机

## 4、快速开发框架Spring Boot

手写starter

## 5、反应式web开发框架WebFlux

strem流编程

- Lambda表达式
- 函数式接口编程
- Lambda方法引用
- Lambda级联表达式和柯里化

异步servlet
sse
reactive Stream流编程 jdk9特性

## 6、微服务框架Spring Cloud



# 1 概述

## 1.1 简介

zookeeper是一个开源的分布式应用程序协调服务器，其为分布式系统提供一致性服务。其一致性是通过基于paxos算法的ZAB协议完成的。
其主要功能包括：

- 配置维护
- 域名服务
- 分布式同步
- 集群管理

ZooKeeper 是一个集中式服务，用于维护配置信息、域名服务、提供分布式同步和集群管理

官网：https://zookeeper.apache.org

### 1.1.1 功能简介

- 配置维护：发布/订阅 （集群）

- 域名服务： 服务映射表 

- 分布式同步：

- 集群管理：

  ![域名服务](picture\1-1-1-01-域名服务.jpg)

  ​

### 1.1.2 一致性：

- 顺序一致性
- 原子性 
- 单一视图
- 可靠性
- 实时性

## 1.2、zookeeper中的重要概念

### 1.2.1 session

​	Session是指客户端会话。Zookeeper对外的服务端口默认是2181，客户端启动时，首先会与zookeeper服务器建立一个tcp长连接，从第一次连接建立开始，客户端会话的生命周期也开始了。通过这个长连接，客户端能够通过心跳检测保持与服务器的有效会话，也能够向zookeeper服务器发送请求并接受响应，同时还能通过该连接接受来自服务器的watcher事件通知。

​	Session的sessionTimeout值用来设置一个客户端会话的超时时间。当由于服务器压力太大、网络故障或是客户端主动断开连接等各种原因导致客户端连接断开时，只要在sessionTimeout规定的时间内客户端能够重新连接上集群中任意一台服务器，那么之前创建的会话仍然有效。

### 1.2.2 znode 



![](picture\1-2-2-01-znode.png)

​	zookeeper的文件系统采用树形层次化的目录结构，与Unix文件系统非常相似。每个目录在zookeeper中叫做一个znode，每个znode拥有一个唯一的路径标识，即名称。

​	Znode可以包含数据和子znode（临时节点不能有子znode）。znode中的数据可以有多个版本，所以查询某路径下的数据需要带上版本号。客户端应用可以在znode上设置监视器（Watcher）。



### 1.2.3 watcher机制

​	zookeeper通过wathcer机制实现了发布订阅模式。zookeeper提供了分布式数据的发布订阅功能，一个发布者能够让多个订阅者同时监听某一主题对象，当这个主题对象状态发生变化时，会通知所有订阅者，使他们能够做出相应的处理。zookeeper允许客户端向服务端注册一个watcher监听，当服务端的一些指定事件触发这个watcher，那么就会向指定客户端发送一个时间通知。而这个事件通知则是通过tcp长连接的session完成的。

### 1.2.4 ACL

​	ACL全称为access control list(访问控制列表)，用于控制资源的访问权限，是zookeeper数据安全的保障。zookeeper利用ACL策略控制znode节点的访问权限，如节点数据读写、节点创建、节点删除、读取子节点列表、设置节点权限等。

​	在传统的文件系统中，ACL分为两个维度：组与权限。一个属组可以包含多种权限，一个文件或目录拥有了某个组的权限即拥有了组里的所有权限。文件或子目录默认会继承其父目录的ACL。

​	而在zookeeper中，znode的ACL是没有继承关系的，每个znode的权限都是独立控制的，只有客户端满足znode的设置的权限要求时，才能完成相应的操作。zookeeper的ACL分为三个维度：

1. 授权策略scheme(密码/ip)
2. 用户id
3. 用户权限permission

## 1.3 Paxos算法

###  1.3.1 算法简介

Paxos算法是莱斯利·兰伯特1990年提出的一种基于消息传递的、具有高容错性的一致性算法。

Google Chubby（分布式锁服务）的作者mike burrows说过，世上只有一种一致性算法，那就是Paxos，所有其他一致性算法都是paxos算法的不完整版。paxos算法是一种公认的晦涩难懂的算法，并且工程实现上也具有很大难度。较有名的paxos工程实现有Google Chubby、ZAB、微信的PhxPaxos等。

paxos算法要解决的问题是，在分布式系统中如何就某个决议达成一致。

### 1.3.2 paxos与拜占庭将军问题

paxos算法的前提是不存在拜占庭将军问题，即信道是安全的、可靠的，集群节点间传递的消息是不会被篡改的。


一般情况下，分布式系统中各个节点间采用两种通讯模型：共享内存（shared memory）、消息传递（messages passing）。
paxos是基于消息传递通讯模型的。

### 1.3.3 算法描述

#### (1) 三种角色

在Paxos算法中有三种角色，分别具有三种不同的行为。但很多时候，一个进程可能同时充当着多种角色。

- proposer:提案的提议者
- acceptor:提案的表决者，即是否通过该提案。只有半数以上acceptor接受了某提案，那么该提案者被认定为“选定”
- learner: 提案的学习者。当提案被选定时，其要同步提议者的天内容，并执行提案内容





一致性算法要保证：
没有提案被提出则不会有提案被选定
每个提议者在提案是都会首先获取到一个具有全局唯一性、递增的提案编号N，即在整个集群中是否唯一的编号N,然后将该编号赋予其要提出的提案。
每个表决者在通过（accept）某提案后，会将该提案的编号N记录在本地，这样每个表决者中保存的已经被通多（accept）的提案中会存在一个编号最大的提案，其编号假设为maxN。每个表决者仅会accept编号大于自己本地maxN的提案
在众多提案中最终只能有一个提案被选定。
一旦一个提案被选定，则其他服务器会主动同步（learn）该提案到本地

#### (2) 算法过程描述

##### 	prepare 阶段 

​	（第二个视频 45:00）	

##### 	accept阶段



### 1.3.4 paxos算法的活锁问题

​	

## 1.4 ZAB协议

### 1.4.1 zab协议简介

ZAB协议是fast paxos算法的一种工业实现算法

ZAB，zookeeper atomic broadcast,zookeeper原子消息广播协议，是专门为zookeeper设计的一种支持崩溃恢复的原子广播协议，在zookeeper中，主要依赖zab协议来实现分布式数据一致性。



### 1.4.2 三类角色


### 1.4.3 三种模式

### 1.4.4 三个数据

### 1.4.5 同步模式与广播模式

### 1.4.6 恢复模式的两个原则

### 1.4.7 leader选举

## 1.5 CAP原则

### 1.5.1 简介

### 1.5.2 三二原则

### 1.5.3 ZK与CP

# 2 zookeeper的安装与集群搭建